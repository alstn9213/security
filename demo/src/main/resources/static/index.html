<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JWT Login Demo</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        input { margin: 5px 0; padding: 5px; width: 100%; box-sizing: border-box; }
        button { padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background-color: #0056b3; }
        .result { background-color: #f4f4f4; padding: 10px; margin-top: 10px; white-space: pre-wrap; word-break: break-all; }
    </style>
    <!-- 포트원(아임포트) 결제 라이브러리 추가 -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>
<div class="container">
    <h2>JWT 로그인 데모</h2>

    <!-- 1. 회원가입 섹션 -->
    <div class="section">
        <h3>1. 회원가입</h3>
        <input type="text" id="joinId" placeholder="아이디">
        <input type="password" id="joinPw" placeholder="비밀번호">
        <input type="text" id="joinName" placeholder="이름">
        <label>
            <input type="checkbox" id="isAdmin" style="width:auto;"> 관리자 계정으로 가입
        </label>
        <input type="text" id="adminToken" placeholder="관리자 토큰 (관리자 체크 시 입력)" style="display:none;">
        <button onclick="join()">가입하기</button>
    </div>

    <!-- 2. 로그인 섹션 -->
    <div class="section">
        <h3>2. 로그인</h3>
        <input type="text" id="loginId" placeholder="아이디">
        <input type="password" id="loginPw" placeholder="비밀번호">
        <button onclick="login()">로그인</button>
        <button onclick="logout()" style="background-color: #6c757d;">로그아웃</button>
        <div id="loginResult" class="result">로그인 상태: 대기중</div>
    </div>

    <!-- 3. API 테스트 섹션 -->
    <div class="section">
        <h3>3. API 테스트 (관리자 전용)</h3>
        <p>로그인 후 받은 Access Token을 헤더에 담아 요청합니다.</p>
        <button onclick="callAdminApi()">관리자 대시보드 조회</button>
        <div id="apiResult" class="result">결과가 여기에 표시됩니다.</div>
    </div>

    <!-- 4. 상품 구매 섹션 -->
    <div class="section">
        <h3>4. 상품 구매 (Iamport 결제)</h3>
        <input type="number" id="itemId" placeholder="상품 ID" value="1">
        <button onclick="requestPay()" style="background-color: #28a745;">결제하기</button>
        <div id="paymentResult" class="result">결제 대기중...</div>
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:8080';

    // 관리자 체크박스 토글 시 토큰 입력창 표시
    document.getElementById('isAdmin').addEventListener('change', function() {
        document.getElementById('adminToken').style.display = this.checked ? 'block' : 'none';
    });

    // 1. 회원가입 요청
    async function join() {
        const id = document.getElementById('joinId').value;
        const password = document.getElementById('joinPw').value;
        const name = document.getElementById('joinName').value;
        const isAdmin = document.getElementById('isAdmin').checked;
        const adminToken = document.getElementById('adminToken').value;

        try {
            const response = await fetch(`${BASE_URL}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: id,
                    password: password,
                    name: name,
                    admin: isAdmin,
                    adminToken: isAdmin ? adminToken : ""
                })
            });

            const text = await response.text();
            if (response.ok) {
                alert('가입 성공: ' + text);
            } else {
                alert('가입 실패: ' + text); // 에러 메시지 출력
            }
        } catch (error) {
            console.error('Error:', error);
            alert('오류 발생');
        }
    }

    // 2. 로그인 요청 및 토큰 저장
    async function login() {
        const id = document.getElementById('loginId').value;
        const password = document.getElementById('loginPw').value;

        try {
            const response = await fetch(`/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, password: password })
            });

            const data = await response.json();

            if (response.ok) {
                // ★ 핵심: 받은 토큰을 LocalStorage에 저장
                localStorage.setItem('accessToken', data.accessToken);
                localStorage.setItem('refreshToken', data.refreshToken);
                
                document.getElementById('loginResult').innerText = 
                    `로그인 성공!\n\nAccess Token (앞부분): ${data.accessToken.substring(0, 20)}...`;
            } else {
                document.getElementById('loginResult').innerText = `로그인 실패: ${data.message || '오류'}`;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loginResult').innerText = '서버 통신 오류';
        }
    }

    // 로그아웃 (토큰 삭제)
    function logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        document.getElementById('loginResult').innerText = '로그아웃 되었습니다.';
        document.getElementById('apiResult').innerText = '';
    }

    // ---------------------------------------------------------
    // ★ JWT Interceptor Logic (토큰 재발급 및 재요청)
    // ---------------------------------------------------------

    // 토큰 재발급 요청
    async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) return null;

        try {
            const response = await fetch(`${BASE_URL}/reissue`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken: refreshToken })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.accessToken);
                localStorage.setItem('refreshToken', data.refreshToken);
                console.log('토큰 재발급 성공');
                return data.accessToken;
            }
        } catch (e) {
            console.error('토큰 재발급 요청 중 에러:', e);
        }
        return null;
    }

    // fetch 래퍼 함수 (Interceptor 역할)
    async function authFetch(url, options = {}) {
        // 1. 헤더에 Access Token 추가
        const accessToken = localStorage.getItem('accessToken');
        if (!options.headers) options.headers = {};
        if (accessToken) {
            options.headers['Authorization'] = `Bearer ${accessToken}`;
        }

        // 2. 원본 요청 시도
        let response = await fetch(url, options);

        // 3. 401(Unauthorized) 발생 시 토큰 재발급 시도
        if (response.status === 401) {
            console.log('Access Token 만료. 재발급 시도...');
            const newAccessToken = await refreshAccessToken();

            if (newAccessToken) {
                // 재발급 성공 시 헤더 갱신 후 재요청
                options.headers['Authorization'] = `Bearer ${newAccessToken}`;
                response = await fetch(url, options);
            } else {
                // 재발급 실패 시 로그아웃
                alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                logout();
            }
        }
        return response;
    }

    // 3. 보호된 API 호출 (Authorization 헤더 사용)
    async function callAdminApi() {
        if (!localStorage.getItem('accessToken')) {
            alert('로그인이 필요합니다.');
            return;
        }

        try {
            // authFetch를 사용하여 요청 (토큰 자동 주입 및 만료 시 재발급 처리)
            const response = await authFetch(`${BASE_URL}/admin/dashboard`, {
                method: 'GET'
            });

            if (response.ok) {
                const text = await response.text();
                document.getElementById('apiResult').innerText = `성공: ${text}`;
            } else {
                // 403 Forbidden 등 에러 처리
                if (response.status === 403) {
                    document.getElementById('apiResult').innerText = '실패: 권한이 없습니다 (관리자 계정만 가능)';
                } else {
                    const errorData = await response.json(); // JSON 에러 응답 파싱 시도
                    document.getElementById('apiResult').innerText = `실패 (${response.status}): ${errorData.message || '오류'}`;
                }
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('apiResult').innerText = 'API 호출 중 오류 발생';
        }
    }

    // ---------------------------------------------------------
    // ★ Iamport 결제 로직
    // ---------------------------------------------------------

    // 가맹점 식별코드 초기화 (포트원 관리자 콘솔에서 확인 가능)
    const IMP = window.IMP;
    IMP.init("imp18800351");

    async function requestPay() {
        if (!localStorage.getItem('accessToken')) {
            alert('로그인이 필요합니다.');
            return;
        }

        const itemId = document.getElementById('itemId').value;

        // 1. 주문 생성 API 호출 (DB에 주문 정보 저장)
        const orderResponse = await authFetch(`${BASE_URL}/api/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                itemId: itemId
            })
        });

        if (!orderResponse.ok) {
            alert('주문 생성 실패: ' + await orderResponse.text());
            return;
        }

        const order = await orderResponse.json();

        IMP.request_pay({
            pg: "html5_inicis",       // PG사 (이니시스 등)
            pay_method: "card",       // 결제 수단
            merchant_uid: order.orderUid, // 주문 번호 (서버에서 생성된 값)
            name: order.item.name,        // 상품명 (서버 Item 정보)
            amount: order.item.price,     // 금액 (서버 Item 정보)
            buyer_email: "test@portone.io",
            buyer_name: "구매자",
            buyer_tel: "010-1234-5678",
        }, async function (rsp) { // callback
            if (rsp.success) {
                document.getElementById('paymentResult').innerText = "결제 성공! 서버 검증 요청 중...";

                // 결제 성공 시 서버로 결제 정보 전송 (검증 및 저장)
                const response = await authFetch(`${BASE_URL}/api/payments/webhook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentUid: rsp.imp_uid,      // 포트원 결제 고유 번호
                        orderUid: rsp.merchant_uid    // 주문 번호
                    })
                });

                if (response.ok) {
                    document.getElementById('paymentResult').innerText = "결제 및 검증 완료!";
                } else {
                    // PaymentService에서 주문을 찾지 못하면 404 에러가 발생할 수 있습니다.
                    const errorText = await response.text();
                    document.getElementById('paymentResult').innerText = `결제는 성공했으나 서버 검증 실패: ${errorText}`;
                }
            } else {
                document.getElementById('paymentResult').innerText = `결제 실패: ${rsp.error_msg}`;
            }
        });
    }
</script>
</body>
</html>
